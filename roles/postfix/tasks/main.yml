---
- name: (1) Definir hostname a FQDN
  ansible.builtin.hostname:
    name: "{{ mail_hostname }}"

- name: Asegurar l√≠nea localhost en /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1'
    line: '127.0.0.1 localhost'
    state: present

- name: Asegurar FQDN en /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^{{ mail_hostname }}'
    line: '{{ ansible_default_ipv4.address }} {{ mail_hostname }} {{ mail_hostname.split(".")[0] }}'
    state: present

- name: (2) Preseed Debconf para Postfix
  ansible.builtin.debconf:
    name: postfix
    question: "{{ item.question }}"
    vtype: "{{ item.vtype }}"
    value: "{{ item.value }}"
  loop:
    - { question: 'postfix/main_mailer_type', vtype: 'select', value: 'Internet Site' }
    - { question: 'postfix/mailname',         vtype: 'string', value: '{{ mail_hostname }}' }
  no_log: true

- name: (3) Instalar Postfix no interactivo
  ansible.builtin.apt:
    name: postfix
    state: present
    update_cache: yes
    dpkg_options: 'force-confdef,force-confold'
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Desplegar main.cf
  ansible.builtin.template:
    src: main.cf.j2
    dest: /etc/postfix/main.cf
    owner: root
    group: root
    mode: '0644'
  notify: new aliases

- name: Set aliases
  template:
    src=aliases
    dest=/etc/aliases
    owner=root
    group=root
    mode=644
  notify:
  - new aliases

- name: (6) Asegurar servicio Postfix corriendo
  ansible.builtin.service:
    name: postfix
    state: started
    enabled: true
